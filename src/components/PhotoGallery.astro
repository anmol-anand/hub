---
import type { ImageMetadata } from 'astro'
import { Icon } from 'astro-icon/components'
import { Image } from 'astro:assets'
import { getFullSizeImages } from '../lib/server-utils'

interface Props {
  name: string
  id: string
  images: ImageMetadata[]
}

const { name, images, id } = Astro.props

// Create a map of full-size image URLs by replacing -preview in the src and stripping query params
const fullSizeImages = await getFullSizeImages(images, id)
---

<div>
  <div class="columns-1 gap-5 sm:columns-2 sm:gap-2 md:columns-3">
    {
      images.map((image, index) => (
        <div class="relative mb-5 break-inside-avoid sm:mb-2">
          <Image
            src={image}
            alt={`Photo ${index + 1} from my trip to ${name}`}
            loading={index < 15 ? 'eager' : 'lazy'}
            decoding={index < 15 ? 'sync' : 'async'}
            class="gallery-item gallery-image"
            draggable={false}
            data-index={index}
            data-fullsize={fullSizeImages[index].src}
            data-fullwidth={fullSizeImages[index].width}
            data-fullheight={fullSizeImages[index].height}
            data-placeholder={fullSizeImages[index].blurDataUrl}
            width={image.width}
            height={image.height}
            widths={[360, 720, 1600, image.width]}
            sizes={`(max-width: 360px) 360px, (max-width: 720px) 720px, (max-width: 1200px) 1200px, ${image.width}px`}
            quality="medium"
          />
        </div>
      ))
    }
  </div>

  <!-- Overlay container -->
  <div
    id="gallery-overlay"
    class="fixed inset-0 z-[9999] hidden bg-background/50 backdrop-blur-lg"
  >
    <div
      class="relative flex h-full items-center justify-center"
      id="overlay-container"
    >
      <!-- Left navigation arrow -->
      <button
        id="prev-button"
        class="absolute left-5 hidden py-5 text-primary opacity-70 transition-opacity duration-300 hover:opacity-100 xl:block"
        aria-label="Previous image"
      >
        <Icon name="lucide:chevron-left" class="size-10" />
      </button>

      <!-- Right navigation arrow -->
      <button
        id="next-button"
        class="absolute right-5 hidden py-5 text-primary opacity-70 transition-opacity duration-300 hover:opacity-100 xl:block"
        aria-label="Next image"
      >
        <Icon name="lucide:chevron-right" class="size-10" />
      </button>

      <!-- Close button -->
      <button
        id="close-button"
        class="absolute right-5 top-5 text-primary opacity-70 transition-opacity duration-300 hover:opacity-100"
        aria-label="Close gallery"
      >
        <Icon name="lucide:x" class="size-8" />
      </button>
    </div>
  </div>
</div>

<script>
  const loadedImageSrcs = new Set<string>()

  // Setup the gallery functionality
  function setupGallery() {
    const galleryImages = document.querySelectorAll(
      '.gallery-item',
    ) as NodeListOf<HTMLImageElement>
    const overlay = document.getElementById('gallery-overlay') as HTMLDivElement
    const overlayContainer = document.getElementById(
      'overlay-container',
    ) as HTMLDivElement
    const prevButton = document.getElementById(
      'prev-button',
    ) as HTMLButtonElement
    const nextButton = document.getElementById(
      'next-button',
    ) as HTMLButtonElement
    const closeButton = document.getElementById(
      'close-button',
    ) as HTMLButtonElement

    let activeImage: HTMLImageElement | null = null
    let currentIndex = -1
    let inactivityTimer: number | null = null

    // Button visibility functions
    function showButtons() {
      prevButton.style.opacity = '0.7'
      nextButton.style.opacity = '0.7'
      closeButton.style.opacity = '0.7'

      // Reset the timer if it exists
      if (inactivityTimer) {
        clearTimeout(inactivityTimer)
      }

      // Start a new timer to hide buttons after 2 seconds
      inactivityTimer = window.setTimeout(hideButtons, 2000)
    }

    function hideButtons() {
      prevButton.style.opacity = '0'
      nextButton.style.opacity = '0'
      closeButton.style.opacity = '0'
    }

    function handleImageClick(event: MouseEvent) {
      const previewImg = event.target as HTMLImageElement

      if (!overlay.classList.contains('hidden')) {
        if (
          event.target === prevButton ||
          event.target === nextButton ||
          (event.target as Element).closest('#prev-button') ||
          (event.target as Element).closest('#next-button') ||
          (event.target as Element).closest('#close-button')
        ) {
          event.stopPropagation()
          return
        }

        handleCloseZoom()
        return
      }

      const imageContainer = document.createElement('div')
      imageContainer.className = 'relative flex items-center justify-center'

      const fullWidth = parseInt(previewImg.dataset.fullwidth || '0', 10)
      const fullHeight = parseInt(previewImg.dataset.fullheight || '0', 10)
      const fullSizeSrc = previewImg.dataset.fullsize || ''
      const placeholderSrc = previewImg.dataset.placeholder || ''

      // Create full-size image
      const fullSizeImg = document.createElement('img')
      fullSizeImg.src = fullSizeSrc
      fullSizeImg.alt = previewImg.alt
      fullSizeImg.className = 'gallery-image-zoom-loading'
      fullSizeImg.width = fullWidth
      fullSizeImg.height = fullHeight
      fullSizeImg.style.zIndex = '2'

      // Save refs
      activeImage = fullSizeImg
      currentIndex = parseInt(previewImg.dataset.index || '0', 10)

      // Check if full-size image is cached
      if (fullSizeImg.complete && fullSizeImg.naturalWidth > 0) {
        fullSizeImg.className = 'gallery-image-zoom-loaded'
        imageContainer.appendChild(fullSizeImg)
      } else {
        // Add placeholder if not cached
        const placeholderImg = document.createElement('img')
        placeholderImg.src = placeholderSrc
        placeholderImg.alt = previewImg.alt
        placeholderImg.className = 'gallery-placeholder-loading'
        placeholderImg.width = fullWidth
        placeholderImg.height = fullHeight
        placeholderImg.style.zIndex = '1'

        fullSizeImg.onload = () => {
          fullSizeImg.className = 'gallery-image-zoom-loaded'
          placeholderImg.className = 'gallery-placeholder-loaded'
          loadedImageSrcs.add(fullSizeImg.src)
        }

        imageContainer.appendChild(placeholderImg)
        imageContainer.appendChild(fullSizeImg)
      }

      overlayContainer.appendChild(imageContainer)

      overlay.classList.remove('hidden')
      document.body.style.overflow = 'hidden'
      showButtons()
      overlay.addEventListener('mousemove', showButtons)
    }

    function handleCloseZoom() {
      if (!activeImage) return

      // Find and remove the image container
      const container = activeImage.parentElement
      if (container) {
        container.remove()
      }

      // Hide overlay
      overlay.classList.add('hidden')
      document.body.style.overflow = ''

      // Clear timer
      if (inactivityTimer) {
        clearTimeout(inactivityTimer)
        inactivityTimer = null
      }

      // Remove mousemove listener
      overlay.removeEventListener('mousemove', showButtons)

      // Reset references
      activeImage = null
      currentIndex = -1
    }

    function navigateGallery(direction: number) {
      if (currentIndex === -1) return

      const imagesArray = Array.from(galleryImages)
      const totalImages = imagesArray.length
      const newIndex = (currentIndex + direction + totalImages) % totalImages
      const targetImg = imagesArray[newIndex]

      const fullsizeSrc = targetImg.dataset.fullsize || ''
      const width = parseInt(targetImg.dataset.fullwidth || '0', 10)
      const height = parseInt(targetImg.dataset.fullheight || '0', 10)
      const alt = targetImg.alt

      handleCloseZoom()

      // If already loaded, skip placeholder and go direct
      if (loadedImageSrcs.has(fullsizeSrc)) {
        const imageContainer = document.createElement('div')
        imageContainer.className = 'relative flex items-center justify-center'

        const img = document.createElement('img')
        img.src = fullsizeSrc
        img.alt = alt
        img.width = width
        img.height = height
        img.className = 'gallery-image-zoom-loaded'
        img.style.zIndex = '2'

        activeImage = img
        currentIndex = newIndex

        imageContainer.appendChild(img)
        overlayContainer.appendChild(imageContainer)
        overlay.classList.remove('hidden')
        document.body.style.overflow = 'hidden'
        showButtons()
        overlay.addEventListener('mousemove', showButtons)
      } else {
        // Fallback to default loading via click (progressive)
        targetImg.click()
      }
    }

    // Add click handlers to all gallery images
    galleryImages.forEach((img) => {
      img.addEventListener('click', handleImageClick as EventListener)
    })

    // Close zoom when clicking on the overlay
    overlay.addEventListener('click', handleCloseZoom)

    // Navigation event listeners with actual navigation functionality
    prevButton.addEventListener('click', (e) => {
      e.stopPropagation()
      navigateGallery(-1)
    })

    nextButton.addEventListener('click', (e) => {
      e.stopPropagation()
      navigateGallery(1)
    })
  }

  // Run setup when the DOM is ready
  document.addEventListener('DOMContentLoaded', setupGallery)

  // Also handle astro:page-load for Astro's view transitions
  document.addEventListener('astro:page-load', setupGallery)
</script>
